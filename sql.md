# SQL

## Содержание



## Основные понятия

**SQL** (Structured Query Language) — это язык структурированных запросов, позволяющий сохранять, манипулировать и извлекать данные из реляционных баз данных.

**Реляционная база данных** — база данных, основанная на реляционной модели данных.  
Понятие «реляционный» основано на англ. *relation* («отношение»).

**Отношение** состоит из заголовка (схемы) и тела. ***Заголовок*** представляет собой множество атрибутов, а ***тело*** — множество кортежей, соответствующих заголовку.  
Отношение обычно имеет простую графическую интерпретацию в виде таблицы, столбцы которой соответствуют атрибутам, а строки — кортежам, а в «ячейках» находятся значения атрибутов в кортежах.

![Отношение](https://github.com/ilsinyakov/QA_Theory/blob/main/Pictures/Relational_database_terms.svg)

В контексте реляционных баз данных:  
**Отношение** — это двумерная таблица с уникальным именем. Она состоит из строк (записей) и столбцов (атрибутов, полей).

Каждая **строка** таблицы представляет некоторый объект реального мира (экземпляр сущности) или соотношения между объектами.

**Столбцы** — это атрибуты сущности, для сущности каждого типа они свои.

**Реляционная БД** — это ограниченный набор особых таблиц с данными. Эти таблицы называются отношениями. Отношения используются для представления сущностей, а также связей между ними.

**Нулевое значение (NULL)** — это значение поля, которое является пустым, т.е. нулевое значение — это значение поля, не имеющего значения. Важно понимать, что нулевое значение отличается от значения 0 и от значения поля, содержащего пробелы. Поле с нулевым значением - это такое поля, которое осталось пустым при создании записи.

## Команды SQL

Стандартными командами для взаимодействия с РБД являются CREATE, SELECT, INSERT, UPDATE, DELETE и DROP. Эти команды могут быть классифицированы следующим образом:
* **DDL** — язык определения данных (Data Definition Language)

|N|Команда|Описание|
|--|--|--|
|1|`CREATE`|Создает новую таблицу, представление таблицы или другой объект в БД|
|2|`ALTER`|Модифицирует существующий в БД объект, такой как таблица|
|3|`DROP`|Удаляет существующую таблицу, представление таблицы или другой объект в БД|

<br>

* **DML** — язык изменения данных (Data Manipulation Language)

|N|Команда|Описание|
|--|--|--|
|1|`SELECT`|Извлекает записи из одной или нескольких таблиц|
|2|`INSERT`|Создает записи|
|3|`UPDATE`|Модифицирует записи|
|4|`DELETE`|Удаляет записи|

<br>

* **DCL** — язык управления данными (Data Control Language)

|N|Команда|Описание|
|--|--|--|
|1|`GRANT`|Наделяет пользователя правами|
|2|`REVOKE`|Отменяет права пользователя|

## Ограничения

**Ограничения** (constraints) — это правила, применяемые к данным. Они используются для ограничения данных, которые могут быть записаны в таблицу. Это обеспечивает точность и достоверность данных в БД.

Ограничения могут устанавливаться как на уровне колонки, так и на уровне таблицы.

Среди наиболее распространенных ограничений можно назвать следующие:

* `NOT NULL` — колонка не может иметь нулевое значение
* `DEFAULT` — значение колонки по умолчанию
* `UNIQUE` — все значения колонки должны быть уникальными
* `PRIMARY KEY` — первичный или основной ключ, уникальный идентификатор записи в текущей таблице
* `FOREIGN KEY` — внешний ключ, уникальный идентификатор записи в другой таблице (таблице, связанной с текущей)
* `CHECK` — все значения в колонке должны удовлетворять определенному условию
* `INDEX` — быстрая запись и извлечение данных

Любое ограничение может быть удалено с помощью команды `ALTER TABLE` и `DROP CONSTRAINT + название ограничения`.

## Целостность данных

В каждой СУБД существуют следующие категории целостности данных:
* целостность **объекта** (Entity Integrity) — в таблице не должно быть дубликатов (двух и более строк с одинаковыми значениями)
* целостность **домена** (Domain Integrity) — фильтрация значений по типу, формату или диапазону
* целостность **ссылок** (Referential integrity) — строки, используемые другими записями (строки, на которые в других записях имеются ссылки), не могут быть удалены
* целостность, определенная **пользователем** (User-Defined Integrity) — дополнительные правила

## Нормализация БД

**Нормализация** — это процесс эффективной организации данных в БД. Существует две главных причины, обуславливающих необходимость нормализации:

* предотвращение записи в БД лишних данных, например, хранения одинаковых данных в разных таблицах
* обеспечение "оправданной" связи между данными

Нормализация предполагает соблюдение нескольких форм. Форма — это формат структурирования БД. 

По правилам нормализации есть семь нормальных форм баз данных:
*	первая,
*	вторая,
*	третья,
*	нормальная форма Бойса-Кодда,
*	четвёртая,
*	пятая,
*	шестая.

Приводить данные к нормальным формам можно только последовательно. То есть в базе данных второй нормальной формы данные по умолчанию уже должны быть нормализованы по правилам первой нормальной формы и так далее. В итоге база данных в шестой нормальной форме — идеально нормализованная. 

В некоторых случаях попытка нормализовать данные до «идеального» состояния может привести к созданию множества таблиц, ключей и связей. Это усложнит работу с базой и снизит производительность СУБД. Поэтому обычно данные нормализуют до ***третьей нормальной формы***. 

### Первая нормальная форма
В базе данных не должно быть дубликатов и составных данных.

Элементы составных данных лучше разнести по разным полям, иначе в процессе работы с данными могут появиться ошибки и аномалии.

### Вторая нормальная форма
Если упростить: у каждой записи в базе данных должен быть первичный ключ. Первичный ключ — это элемент записи, который не повторяется в других записях.

### Третья нормальная форма
В записи не должно быть столбцов с неключевыми значениями, которые зависят от других неключевых значений.

Данные не во всех случаях преобразовывают до третьей формы. Иногда для этого придётся создать много небольших таблиц, что усложнит базу и задачу разработчикам.

## Синтаксис SQL

```sql
-- выборка
SELECT col1, col2, ...colN
FROM tableName;

SELECT DISTINCT col1, col2, ...colN
FROM tableName;

SELECT col1, col2, ...colN
FROM tableName
WHERE condition;

SELECT col1, col2, ...colN
FROM tableName
WHERE condition1 AND|OR condition2;

SELECT col2, col2, ...colN
FROM tableName
WHERE colName IN (val1, val2, ...valN);

SELECT col1, col2, ...colN
FROM tableName
WHERE colName BETWEEN val1 AND val2;

SELECT col1, col2, ...colN
FROM tableName
WHERE colName LIKE pattern;

SELECT col1, col2, ...colN
FROM tableName
WHERE condition
ORDER BY colName [ASC|DESC];

SELECT SUM(colName)
FROM tableName
WHERE condition
GROUP BY colName;

SELECT COUNT(colName)
FROM tableName
WHERE condition;

SELECT SUM(colName)
FROM tableName
WHERE condition
GROUP BY colName
HAVING (function condition);

-- создание таблицы
CREATE TABLE tableName (
  col1 datatype,
  col2 datatype,
  ...
  colN datatype,
  PRIMARY KEY (одна или более колонка)
);

-- удаление таблицы
DROP TABLE tableName;

-- создание индекса
CREATE UNIQUE INDEX indexName
ON tableName (col1, col2, ...colN);

-- удаление индекса
ALTER TABLE tableName
DROP INDEX indexName;

-- получение описания структуры таблицы
DESC tableName;

-- очистка таблицы
TRUNCATE TABLE tableName;

-- добавление/удаление/модификация колонок
ALTER TABLE tableName ADD|DROP|MODIFY colName [datatype];

-- переименование таблицы
ALTER TABLE tableName RENAME TO newTableName;

-- вставка значений
INSERT INTO tableName (col1, col2, ...colN)
VALUES (val1, val2, ...valN)

-- обновление записей
UPDATE tableName
SET col1 = val1, col2 = val2, ...colN = valN
[WHERE condition];

-- удаление записей
DELETE FROM tableName
WHERE condition;

-- создание БД
CREATE DATABASE [IF NOT EXISTS] dbName;

-- удаление БД
DROP DATABASE [IF EXISTS] dbName;

-- выбор БД
USE dbName;

-- завершения транзакции
COMMIT;

-- отмена изменений
ROLLBACK;
```
