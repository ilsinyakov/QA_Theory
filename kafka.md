# Apache Kafka

## Ручное тестирование Kafka

1. **Проверка отправки сообщений**
   - Использование командной строки:

     ```bash
     kafka-console-producer.sh --broker-list localhost:9092 --topic test-topic
     ```

   - Ввод тестового сообщения и проверка его появления в топике через консьюмер:

     ```bash
     kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test-topic --from-beginning
     ```

2. **Проверка доставки сообщений**
   - Запуск консьюмера с указанием группы:

     ```bash
     kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test-topic --group test-group
     ```

   - Проверка, что сообщения доставляются и обрабатываются корректно.

3. **Проверка работы партиций**
   - Создание топика с несколькими партициями:

     ```bash
     kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 3 --topic multi-partition-topic
     ```

   - Отправка сообщений и проверка их распределения по партициям.
  
### Инструменты

- Kafka CLI (kafka-console-producer, kafka-console-consumer) — основной инструмент.
- Kafka Offset Explorer (Kafka Tool) — GUI для визуального анализа.
- UI-админки.
- HTTP-инструменты: Postman (если используется Kafka REST Proxy).

### Типичные сценарии для чек-листа

1. Сообщение, отправленное продюсером, появляется в топике и может быть прочитано.
2. Консьюмер читает сообщение и корректно его обрабатывает (логирует, сохраняет в БД).
3. При обработке с ошибкой сообщение не теряется (уходит в DLQ или повторяется).
4. Оффсет консьюмера увеличивается только после успешной обработки.
5. Два консьюмера в одной группе не получают одинаковые сообщения (нет дублей).
6. Консьюмер в новой группе (group.id) читает все сообщения с начала (from-beginning).
7. При перезапуске консьюмера он продолжает с последнего коммитнутого оффсета.
8. Продюсер может отправлять сообщения с ключом (key), и все сообщения с одним ключом попадают в одну партицию.

## Kafka Offset Explorer

1. Кратко об инструменте  
**Kafka Offset Explorer** (ранее известный как Kafka Tool) — это графический клиент для администрирования и мониторинга Apache Kafka. Он позволяет визуально исследовать кластеры, топики, партиции, потребителей (consumer groups) и, что ключевое, их оффсеты (смещения). Для QA-инженера это мощный инструмент для валидации данных, отладки и проведения интеграционного тестирования.

2. Основные сценарии использования для QA

    - Валидация доставки сообщений (Data Verification):

      «После выполнения тестового сценария (например, отправки события из тестируемого приложения) я могу открыть Offset Explorer, найти нужный топик и просмотреть сообщения в конкретной партиции. Это позволяет убедиться, что сообщение корректно создано, содержит правильные заголовки (headers) и payload (тело сообщения в JSON, Avro и т.д.). Это прямой способ проверки работы продьюсеров.»

    - Проверка потребления сообщений (Consumer Lag Analysis):

      «Я могу отслеживать отставание (lag) consumer groups. Это разница между последним сообщением в партиции (log-end offset) и текущим оффсетом потребителя (current offset). Большой lag указывает на проблемы: потребитель может «застрять», не успевать обрабатывать сообщения или упасть. Для интеграционных тестов это критическая метрика — мы проверяем, что наша система-потребитель не теряет данные.»

    - Воспроизведение проблем (Debugging & Reproducing Issues):

      «Если в логах тестовой среды есть ссылка на Kafka-сообщение (например, offset или ключ), я могу быстро найти его в Offset Explorer и детально изучить. Это помогает локализовать проблему: было ли сообщение отправлено? Было ли оно искажено? Дошло ли оно до нужного топика?»

    - Подготовка тестовых данных:

      «Перед запуском тестов я могу проверить, пуст ли топик, или, наоборот, вручную удалить старые сообщения (с осторожностью, в dev/QA средах!), чтобы обеспечить чистоту теста. Также можно посмотреть, какие данные уже есть, чтобы использовать их в качестве пререквизитов.»

    - Мониторинг состояния тестовой среды:

      «Регулярный чек: живы ли брокеры, все ли топики, описанные в требованиях, созданы, правильно ли настроено количество партиций и реплик. Это часть проверки корректности развертывания (deployment verification).»

3. Практические шаги (пример)

    Конкретные шаги при работе:

    - Подключаюсь к кластеру Kafka тестовой среды (указываю bootstrap servers).
    - В дереве слева нахожу нужный топик.
    - Выбираю вкладку Data для просмотра сообщений. Указываю диапазон оффсетов для выборки.
    - Для анализа потребителей перехожу во вкладку Consumer Groups, нахожу нужную группу и смотрю детали по каждой партиции: current offset, lag, владелец (client-id).

4. Интеграция в процесс тестирования

    Я бы использовал Offset Explorer не изолированно, а как часть процесса:

    - При автотестах: Для предварительной настройки состояния топика и пост-проверки (assert) факта появления сообщения.
    - При расследовании инцидента в тестовой среде: Как первый инструмент быстрой диагностики потока данных.
    - Вместе с логированием: Сопоставлял логи потребителя или продьюсера с реальным положением дел в топике.

5. Важные предостережения (это покажет зрелость)

Я понимаю, что в production-среде права на такие операции сильно ограничены. В тестовых же средах я всегда согласовываю свои действия, особенно удаление данных, с командой, чтобы не сломать тесты коллег. Также важно помнить, что просмотр сообщений возможен, только если данные не зашифрованы.
