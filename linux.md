# Linux

## Пользователи, группы и права доступа

### Учетные записи ОС

1. **Стандартные учетные записи**: создаются для обычных пользователей.  
> Стандартные учетные записи: могут входить в систему, выполнять команды и читать некоторые файлы или директории. Они не могут изменять любую часть ОС и "общесистемных" приложений. По умолчанию они могут изменять данные только в своих домашних директориях и /tmp.
2. **Административная учетная запись**: ее имя - root, и она является единственным администратором ОС (у вас не может быть двух root). Учетная запись root используется для прямого входа в систему очень редко; вместо этого администраторы временно повышают свои привилегии до root для обслуживания системы и других важных операций.  
> Административная (root) учетная запись: может входить в систему и делать все с ОС и пользователями без каких-либо ограничений (в отличие от Windows, где учетная запись администратора не настолько мощная, как учетная запись "Локальная система").
3. **Служебные учетные записи**: создаются для служб и других специальных целей; не должны использоваться пользователями. Например, для запуска бэкэнд-приложения (или приложения сервера базы данных) должна использоваться отдельная учетная запись.  Это минимизирует возможные последствия в случае сбоя или взлома приложения.  
> Служебные учетные записи: не могут входить в систему. ОС, службы и приложения (запускаемые root) используют их для специальных целей, например, для запуска определенных программ, служб и т.д.

**Основные настройки учетной записи: /etc/passwd**

`/etc/passwd` - это основной конфигурационный файл для учетных записей пользователей

`egrep ${USER} /etc/passwd` - информация о своей учетной записи.

Формат файла. В качестве разделителя полей используется ':', таким образом:  
`feodor:x:1000:100:User Description Here:/home/feodor:/bin/bash`  
* feodor - имя пользователя, должно быть уникальным
* x - поле не используется, поэтому мы имеем здесь 'x' как заглушку
* 1000 - идентификатор пользователя, называемый "UID", должен быть уникальным. Пользователи в основном имеют UID >= 1000. Пользователь root всегда имеет UID 0. Учетные записи служб имеют UID от 1 до (в основном) 999. Никто, кроме root, не должен иметь UID 0.
* 100 - идентификатор основной группы. Каждый пользователь должен быть членом хотя бы одной группы (не существует пользователей "без групп"). Если пользователей нужно включить в большее количество групп, это настраивается в /etc/group (см. следующий раздел).
* User Description Here - это поле может быть пустым или содержать что угодно, кроме ':'. Оно не играет никакой роли в ОС и механизмах входа в систему.
* /home/feodor - домашний каталог пользователя; вы автоматически помещаетесь сюда после успешного входа в систему
* /bin/bash - программа, выполняемая при успешном входе в систему. Сервисные учетные записи не предназначены для входа в систему и работы в командной строке, поэтому у них здесь указаны специальные "псевдо" программы, такие как /bin/false или /sbin/nologin

Хеши паролей хранятся в файле `/etc/shadow`

### Группы ОС

Понятие групп в UNIX:

* Группы включают несколько (0 или более) пользователей для упрощения управления пользователями и разделения привилегий
* Каждый пользователь должен быть членом как минимум одной группы - она задается в `/etc/passwd`, такая группа называется "основной" для конкретного пользователя
* Каждый пользователь может быть включен в 0 или более дополнительных групп, называемых "вторичными группами" (secondary groups). Членство во вторичных группах настраивается в файле `/etc/group`.
* Нет никакой разницы (в плане привилегий) между членством в первичной и вторичной группах.

`egrep ${USER} /etc/group`  
```
wheel:x:10:feodor
users:x:100:feodor,[ ... a lot of users here ... ]
feodor:x:1000:
qa:x:1001:feodor,user1,user2
```  
* Название группы
* Всегда 'x'
* Идентификатор группы, называемый "GID", должен быть уникальным
* Список членов группы, разделенный запятыми, может быть пустым

Членство в группе зависит от `/etc/passwd` и `/etc/group` - например, группа "qa" имеет только 3 явно включенных члена, но может быть много других членов в группах "qa", определенных в `/etc/passwd` путем указания 1001 в качестве основного GID. 

### Команды для работы с пользователями и группами

`whoami` - получить имя текущего пользователя

`id` - получить расширенную информацию о текущем пользователя и его членстве в группах  
`id -u` - только UID  
`id -G` - только GID  
`id -Gn` - имена групп

`groups` - имена групп

### Повышение привилегий

#### "su": Переключить пользователя

Команда `su` используется для запуска оболочки от имени другого пользователя (по умолчанию root) после предоставления пароля пользователя. Соответственно, все, что выполняется в этой оболочке, будет выполняться с привилегиями целевого пользователя.   
Чтобы вернуться к предыдущему пользователю, выполните команду `exit`.

`su - username` - переключает терминал на указанного пользователя. Будет запрошен пароль. `-` - переключает окружение на окружение нового пользователя. Пользователь "root" может переключаться на любого другого без ввода пароля цели.  
`su - -c "id -u; whoami"` - выполнение нескольких команд от имени root без переключения терминала.  

#### "sudo": Выполнить что-то с заменой пользователя (Substitute User Do)

Инструмент `sudo` используется для запуска команды от имени другого пользователя (по умолчанию root) после предоставления пароля. Вводится собственный пароль, а не пароль целевого пользователя. "sudo" может быть настроен на разрешение или запрет выполнения определенных команд и их аргументов.  
`sudo` предназначен для того, чтобы позволить определенным пользователям выполнять определенные команды (и только их, ничего больше!) от имени другого, часто привилегированного, пользователя.  

`sudo -l` - проверить, какие команды разрешены текущему пользователю  
`sudo [-u username] command args` - синтаксис sudo  

### Разрешения на доступ к файлам

`-rw-r--r--`  
1й символ - тип файла:  
* '-' для типичных файлов  
* 'd' для каталогов  
* 'l' для символических ссылок  
* Другие: s, p, c, b - для специальных целей  

`rwx  rwx  rwx`  
USER-GROUP-OTHER (Владелец-Группа-Другие)

rwx  
READ-WRITE-EXECUTE (Чтение-Запись-Выполнение)  

|Бит|Значение для файлов|Значение для директорий|
|-|-|-|
|r - read (чтение)|Файл может быть прочитан, например, с помощью cat, less, head, других инструментов.|Список содержимого каталога может быть прочитан. Если бит 'x' не установлен, могут быть прочитаны только имена объектов.|
|w - write (запись)|Содержимое файла может быть изменено. Но сам файл не может быть удален - см. 'w' для каталогов.|Любой элемент этого каталога может быть создан или удален. То есть, даже если вы не являетесь владельцем файла в этом каталоге, вы можете удалить его, установив 'w' для каталога. Это можно сделать только в том случае, если бит 'x' также установлен.|
|x - execute (выполнение)|Файл может быть выполнен. Фактически исполняемые файлы: двоичные файлы и скрипты|Вы можете войти в этот каталог (например, с помощью "cd") и получить доступ (чтение, запись, выполнение) ко всему его содержимому, если это разрешено их правами доступа. Если у вас нет 'x' для каталога, вы НЕ можете: <ul><li> переходить в подкаталоги</li> <li> создавать/удалять объекты (файлы, каталоги)</li> <li>читать информацию об объекте (разрешения, владелец, ...)</li></ul>|

#### Цифровое представление разрешений

* r' равно 4 (100)  
* 'w' равно 2 (010)  
* 'x' равно 1 (001)  
* '-' равно 0 (000)  

все их комбинации являются суммами этих чисел, например:  
* 'r-x' равно 5 (101)
* 'rw-' равно 6 (110)
* 'rwx' равно 7 (111)

#### Команды для изменения разрешений доступа к файлам

`chown` (ИЗМЕНИТЬ ВЛАДЕЛЬЦА): для установки нового владельца и/или группы для объекта  
`chgrp` (ИЗМЕНИТЬ ГРУППУ): то же самое, но только для группы  
`chmod` (ИЗМЕНИТЬ РЕЖИМ): установить новые разрешения доступа к файлу  

Команда "chown" имеет ряд ограничений для "обычных" пользователей, ее полная мощность доступна только пользователю root:  
* изменить только владельца объекта - может быть выполнена только пользователем root
* изменить только группу объекта - может быть выполнена обычным пользователем, но этот пользователь должен быть членом новой группы (иначе требуются привилегии root)
* изменить владельца и группу объекта сразу - только для root

Синтаксис:  

`chown [-R] [username]:[group] object`  
-R - команда применяется ко всей директории

`chgrp [-R] group object`

`chmod 751 ~/chmod.me.dir` - Установим "rwxr-x--x", т.е. 751, на указанную директорию  
`chmod g+w,o+r ~/chmod.me.dir` - Добавляем "w" для группы и "r"-бит для прочих (others)  
`chmod u=rwx,g+w,o-r ~/chmod.me.dir` - Разрешаем владельцу делать что угодно с директорией, добавляем права на запись группе, отбираем права на чтение у прочих (others)  
`chmod -R go-rwx ~/chmod.me.dir` - Меняем права доступа для всего каталога, отнимаем все права у группы и прочих (others)

#### Особые случаи

##### Символические ссылки

**Символические ссылки** всегда имеют разрешения 777, но это ничего не значит, поскольку фактические разрешения доступа такие же, как у целевого объекта.

##### Sticky bit

Может использоваться для директорий наряду с "обычными" битами доступа rwx. Если он установлен, **только владельцы могут удалять объекты**, независимо от разрешения других (например, 777 для /tmp). Sticky bit отображается как '**t**' в конце "слова" разрешения доступа: "drwxrwxrwt".  
sticky bit имеет цифровое значение 1: например, 1777.  

Он может быть установлен в цифровой или символьной форме:
`chmod +t /some/dir`  
`chmod 1777 /some/dir`  

##### Биты SUID и SGID

Бит SUID (Set User ID) может использоваться для исполняемых файлов. Если он установлен, этот файл всегда будет **выполняться от имени владельца**. Бит SUID отображается как '**s**' вместо 'x' в блоке разрешений владельца:  
`-rws--x--x`  

Бит SGID - тоже самое для групп:
`-r-xr-sr-x`

Бит SUID имеет цифровое значение 4, а SGID - 2:  
`4755/-rwsr-xr-x`  
`2555/-r-xr-sr-x`

Эти специальные биты можно установить с помощью инструмента chmod:  
```
# SUID bit
chmod u+s /path/to/file
chmod 4xyz /path/to/file

# SGID bit
chmod g+s /path/to/file
chmod 2xyz /path/to/file
```






  






