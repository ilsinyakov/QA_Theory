# Сети

## Основные понятия сетей

### Модель клиент-сервер

Большая часть данных в Интернете передается между двумя узлами. Первый узел — это программа, которая хочет получить данные, называемая "клиент". В нашем примере клиентом является веб-браузер. Когда вы открываете веб-сайт, браузер пытается подключиться к этому сайту и запросить данные.

Второй узел — это сервер, программа, обрабатывающая ваш запрос (здесь и далее в этой главе под сервером мы понимаем программу, а не специальный компьютер, отличающийся от вашего ноутбука или настолького ПК).

Отправка запроса из терминала:
```
nc example.com 80
GET / HTTP/1.1
Host: example.com
```

### Адреса и маршрутизация

Вы написали в адресной строке веб-браузера «example.com» и нажали Enter. Адрес example.com понятен людям, однако компьютерам ничего о нём не известно. Это просто удобное для людей доменное имя, которое для использования компьютером необходимо преобразовать в так называемый IP-адрес. Процесс преобразования одного адреса в другой называется **resolving** («разрешение»).

Этот процесс - "разрешение имени", или, если короче, resolving - работает следующим образом: ваша операционная система берет адрес DNS-сервера из своих сетевых настроек. Когда вы пытаетесь подключиться к ресурсу с определённым доменным именем, ОС отправляет серверу DNS специальный запрос: «отправь мне IP-адрес, соответствующий имени example.com». Получив запрос, сервер DNS ищет в очень большой таблице адрес для имени example.com и отправляет результат.

Теперь компьютер знает адрес ресурса с именем example.com.

Узнать IP-адрес:  
`host example.com` - Linux  
`nslookup example.com` - Windows

Статус DNS-сервера:  
`resolvectl status` - Linux  
`ipconfig /all` - Windows  

**IP-адрес** — это набор из четырёх чисел, разделённых точками. Каждое число (они называются октетами) должно быть между 0 и 255. Например: 127.0.0.1, 8.8.8.8 или 192.168.0.1. Вы можете воспринимать его как почтовый индекс, необходимый для отправки посылки определённому человеку. IP-адрес есть у всех устройств, подключённых к современным сетям.

Чтобы установить соединение с удаленным узлом, нужно знать еще одно число, называемое **номером порта**. Если IP-адрес — это почтовый индекс здания, то порт — это дверь с определённым номером в этом здании. В большинстве случаев каждый номер порта используется только для конкретной службы или протокола. Нам необходимо установить соединение HTTPS, поэтому будем использовать номер порта 443 (он используется для этого протокола по умолчанию, поэтому его не нужно будет указывать).

Итак, у нас есть адреса и номера портов, чтобы можно было отправить запрос.

Но есть одна маленькая проблема: мы не знаем, как добраться до сервера назначения, поскольку он может находиться где угодно, даже в другой стране или на другом континенте. На самом деле нам не нужно знать полный маршрут, так же как нам не нужно его знать, когда отправляем открытку другу. Нам необходимо лишь найти ближайший почтовый ящик.

Скорее всего, ваш компьютер уже подключен к локальной сети, и у вас уже есть  IP-адрес; кстати, IP расшифровывается как "Internet Protocol", т.е. "протокол межсетевого общения". Кроме того, если у вас дома есть роутер, то поздравляем — у вас уже есть собственная маленькая локальная сеть!

По сути, Интернет - не что иное, как огромное количество сетей, соединенных друг с другом. Как каждый компьютер, подключённый к Интернету, обладает IP-адресом, так и каждый IP-адрес является частью некой сети. У сетей тоже есть адреса, состоящие из двух частей, разделённых косой чертой: **адрес сети** (network address) и **маска подсети** (netmask).

Адрес сети выглядит абсолютно так же, как IP-адрес узла. А маска сети (или "подсети", могут применяться оба термина) — это просто число между 0 и 32, с помощью которого компьютер узнаёт размер сети и диапазон IP-адресов, доступных в ней.

Чем больше значение маски подсети, тем меньше размер подсети и тем меньше IP-адресов в ней.
Например, маска /24 соответствует 256-и IP-адресам, а /28 — только 16-и.

Также маску подсети можно записать в длинной форме. В этом случае она выглядит похожей на IP-адрес.
Например, /16 и 255.255.0.0 — это одна и та же маска подсети в короткой и длинной форме соответственно.

Операционная система применяет адреса сетей и их маски внутри очень важной таблицы, называемой **таблица маршрутизации** (routing table).
С помощью этой таблицы компьютер узнаёт, как подключиться к тому или иному адресу.

`ip route list` - таблица маршрутизации Linux
`route -4 PRINT` - таблица маршрутизации Windows

Внутри каждой сети, подключенной к интернету (или просто к другим сетям, даже без выхода в Интернет), должен быть шлюз. **Шлюз** — это специальным образом сконфигурированный компьютер или сетевое устройство, подключённое к двум или более сетям и способное пересылать данные из одной сети в другую. Наиболее распространённым примером аппаратного сетевого шлюза является домашний роутер. IP-адрес шлюза указывается в настройках сети каждого подключенного к этой сети компьютера.

Таким образом, когда пользователь хочет установить соединение с любым другим узлом из внешних сетей, операционная система будет применять маршрут по умолчанию, чтобы отправить клиентский запрос через свой шлюз. Далее ближайший шлюз пересылает запрос другому шлюзу, тот в свою очередь — следующему и т. д. Каждый шлюз маршрута называют  **хоп**, или транзитный узел. Таким образом ваш запрос и достигает сервера example.com.

Получив запрос, сервер формирует ответ и отправляет его аналогичным способом.

Узнать IP-адрес, маску подсети:  
`ifconfig`  
`ip addr list` - Linux

`ipconfig` - Windows

Построение маршрута:  
`traceroute example.com` - Linux  
`tracert example.com` - Windows

### Физический уровень

В момент, когда данные уже готовы к передаче, клиентская ОС запрашивает сетевой адаптер для отправки этих данных по кабелю или беспроводному каналу. Сетевому адаптеру ничего не известно об IP-адресах, масках посети, шлюзе, используемом по умолчанию, и других программных сущностях, таких как ОС или предпочитаемый веб-браузер. Зато ему известен свой уникальный аппаратный адрес, называемый **MAC-адресом** (Media Access Control address — адрес управления доступом к среде передачи данных). MAC-адрес состоит из шести пар шестнадцатеричных символов, разделённых двоеточиями, например 46:09:9f:f5:87:aa.

К этому моменту уже известно, что узел example.com находится за пределами вашей сети, поэтому вам нужен шлюз (в данном случае это 10.8.0.1). Первым делом операционная система запросит сетевой адаптер отправить специальное широковещательное сообщение: «узел с IP 10.8.0.1, ответь, мне нужен твой MAC-адрес, чтобы пообщаться с тобой» (при этом 10.8.0.1 — адрес из нашей локальной сети). В случае успеха операционная система получит следующую информацию: «узел с IP-адресом 10.8.0.1 обладает MAC-адресом 46:09:9f:f5:87:aa», и запишет её в специальную таблицу. В этой таблице отображаются устройства, с которым ваш узел "общался" в пределах локальной сети.
Так работает протокол **ARP** (Address Resolution Protocol — протокол определения адресов).

На следующем шаге клиентская ОС запрашивает сетевой адаптер передать сообщение вида "Узел с MAC-адресом  46:09:9f:f5:87:aa, для тебя есть сообщение: [текст сообщения]". Операционная система роутера (внутри этой маленькой коробочки также есть ОС) поместит ваше сообщение в пакет программного уровня, прочтёт IP-адрес узла назначения, выберет нужный интерфейс для дальнейшей пересылки и отправит сообщение через физический уровень этого интерфейса.

**Сетевой адаптер** (также может применяться термин **сетевой интерфейс**) - физическое или виртуальное оборудование, предназначенное для приема-передачи сигналов по сети. Узлы и сетевые интерфейсы связаны как "один ко многим" (аналогично сущностям баз данных), например:

* Компактный ноутбук может иметь всего 1 встроенный физический сетевой интерфейс, это WiFi-адаптер
* Ноутбук большего размера как правило имеет 2 и более физических сетевых интерфейса, например один WiFi-адаптер и одну сетевую Ethernet-карту
* Cовременные смартфоны имеют как минимум 2 сетевых интерфейса (оба - беспроводные): один для передачи данных по мобильным сетям (4G или 5G), второй - WiFi-адаптер
* Маршрутизаторы как правило имеют 2 или более сетевых интерфейса для соединения с разными сетями и передачи данных между ними
* При установке VPN-соединения в системе появляется еще минимум 1 виртуальный сетевой интерфейс для обмена данными внутри VPN-соединения

Даже если у компьютера нет ни одного исправного физического сетевого интерфейса, все равно в системе присутствует минимум 1 виртуальный интерфейс, часто называемый loopback-интерфейсом или "интерфейсом обратной петли". Он нужен для взаимодействия клиентского и серверного ПО, запущенного на одном и том же узле.

Не бывает случаев, когда один и тот же сетевой интерфейс принадлежит нескольким разным узлам. Даже если на узле запущено несколько виртуальных машин, которые имеют доступ к одному и тому же физическому сетевому интерфейсу, каждая из виртуальных машин имеет свой собственный виртуальный сетевой интерфейс.

Как отмечалось выше, должна быть связь между сетевыми интерфейсами и IP-адресами. Эта связь также имеет тип "один ко многим"; примеры ниже указаны в порядке убывания вероятности встретить такие настройки:

1. Самый частый случай: 1 сетевой интерфейс имеет 1 IP-адрес. Чаще всего именно так и происходит, когда вы подключаете узел к локальной сети.
2. Один сетевой интерфейс не имеет ни одного настроенного IP-адреса. Пример: вы включаете ноутбук там, где нет никаких точек доступа WiFi.
3. Один сетевой интерфейс имеет несколько IP-адресов. Такие настройки могут быть встретиться на сетевых устройствах или серверах в специфических ситуациях.

Один и тот же IP-адрес НЕ может быть назначен нескольким сетевым интерфейсам в рамках одной сети.

Cодержимое ARP-таблицы вашего компьютера:
`arp -a -n` - Linux  
`arp /a` - Windows

## TCP/IP

**TCP/IP** — сетевая модель передачи данных, представленных в цифровом виде. Модель описывает способ передачи данных от источника информации к получателю.

Модель TCP/IP разделена на четыре уровня (иногда на пять; самый нижний уровень, физический):
1. **Прикладной уровень (Application Layer)**. Как следует из названия, это группа протоколов, служащих для взаимодействия между приложениями. Они используются каждый раз, когда пользователь запрашивает в сети какую-либо информацию с помощью приложения. Большая часть протоколов, работающих в рамках модели клиент-сервер, относится к прикладному уровню.
*HTTP*-протокол, упомянутый в предыдущем модуле, является наглядным примером прикладного протокола. Запрос клиента GET и ответ сервера с кодом 200 (успешное выполнение запроса), отправленные по протоколу HTTP 1.1 являются передачей данных приложения через сеть.
Протоколы прикладного уровня предназначены для запроса и передачи данных, то есть на этом уровне задаётся вопрос “***ЧТО*** должно быть отправлено и получено”.
2. **Транспортный уровень (Transport Layer)**. Для управления передачей данных необходимо добавить некоторую служебную информацию: номера портов, поле подтверждения доставки или специальные данные для управления скоростью передачи.
Вспомните практические упражнения и домашнее задание из предыдущего модуля, где для доступа к веб-серверу с сайтом example.com использовались программы nc и telnet. Такие числа, как 80 и 443, являются номерами портов. Эту служебную информацию необходимо добавить к данным приложения до их отправки другой стороне.
Самые распространённые протоколы транспортного уровня это *TCP* (Transmission Control Protocol — протокол управления передачей) и *UDP* (User Datagrams Protocol — протокол пользовательских датаграмм).
Протоколы транспортного уровня описывают ***КАК ИМЕННО*** запросы и ответы должны отправляться и приниматься: какой порт использовать, нужно ли проверять целостность данных и очерёдность пакетов, нужно ли повторно отправлять потерянные пакеты и т. д.
3. **Сетевой уровень (Network Layer)**. Предназначен для адресации и поиска узла назначения, а также для маршрутизации. В модели TCP/IP сетевой уровень представлен протоколом *IP* (Internet Protocol — межсетевой протокол). Как видно из названия, это вторая часть, необходимая для реализации модели. Этот уровень отвечает на вопрос, ***как клиентам и серверам найти друг друга***, даже если они расположены в различных несмежных сетях. Например, чтобы обеспечить доступ к серверу example.com из домашнего компьютера, задействуется протокол IP с элементами, необходимыми для маршрутизации.
4. **Уровень сетевого интерфейса** (Datalink Layer / Interface Layer, он же "канальный уровень", либо "уровень сетевого доступа"). Говоря о предыдущих уровнях, мы обсуждали программные сущности, но они не могут обойтись без физической передачи данных от одного компьютера к другому. Этот уровень служит интерфейсом между программным обеспечением (ПО) и физическими устройствами, например адаптерами для ***Ethernet, Wi-Fi, Bluetooth*** или модемами DSL.  Этот уровень также применяется для соединения устройств, находящихся в одной локальной сети, где используются аппаратные адреса без обращения к IP-адресам.
5. Иногда упоминается ещё один уровень — **физический уровень** (Physical Layer). Он располагается после уровня сетевого интерфейса и используется для  передачи данных по физической среде, например медному проводу, оптическому волокну или воздуху. На этом уровне нет программных протоколов, только физические сигналы.

Каждый уровень можно рассматривать независимо, например:
* Сетевые приложения, работающие на верхнем уровне, ничего не знают об интерфейсе или физическом уровне. Разработчики приложений не заботятся о том, передаются ли данные через Ethernet по медному проводу, через Wi-Fi или спутник.
* Программному обеспечению сетевого уровня (протокол IP) нет разницы, какие именно данные отправляет приложение на удалённый компьютер; главная задача этого уровня — проложить путь между клиентом и сервером.

