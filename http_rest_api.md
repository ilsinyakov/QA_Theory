# HTTP, REST, API

## Содержание

* [Протокол. Понятие](#протокол-понятие)
* [Протокол HTTP](#протокол-http)
* [HTTPS](#https)
* [URL, URN, URI](#url-urn-uri)
* [Методы HTTP](#методы-http)
* [Запрос и ответ HTTP](#запрос-и-ответ-http)
  * [Коды состояния HTTP](#коды-состояния-http)
  * [Заголовки HTTP](#заголовки-http)
  * [Тело запроса и ответа HTTP](#тело-запроса-и-ответа-http)
* [Архитектурный стиль REST](#архитектурный-стиль-rest)
* [API](#api)
  * [Документация для API](#документация-для-api)
  * [Инструменты для тестирования](#инструменты-для-тестирования)
    * [cURL](#curl)
      * [Swagger](#swagger)
      * [Подключаемые модули веб-браузеров](#подключаемые-модули-веб-браузеров)
      * [Postman](postman)
  * [Тестирование REST API](#тестирование-rest-api)

## Протокол. Понятие

**Протокол**, или протокол передачи данных, в вычислительных сетях — это набор правил, определяющих логику отправки системами сообщений друг другу.

Эти правила устанавливают стандартизированный подход к отправке/получению сообщений и обработке ошибок (ошибки передачи данных должны обрабатываться четким и предсказуемым образом). Протокол можно рассматривать как договор на отправку данных между вычислительными системами.

## Протокол HTTP

**Гипертекст** - cчитается, что гипертекст был изобретен в 1960-х. По сути, он представляет собой текст (документ), содержащий ссылки на другой текст (документы). Такой подход позволяет читать документы, на которые есть ссылки, в любом порядке, удобном конкретному читателю. Весь текст перестаёт быть линейным, и каждый пользователь может изучать его по-своему.

**HTTP**, как вы знаете, означает **HyperText Transfer Protocol** — протокол передачи гипертекста. Он определяет набор правил, задающих логику отправки и приёма гипертекстовых документов. По крайней мере, такова была первоначальная идея. Сегодня HTTP используется для передачи не только гипертекста, но и других типов данных, таких как изображения, видео, исполняемые файлы.

Он используется в двух основных случаях:

* В качестве протокола для передачи данных между браузером и веб-сервером.
* В качестве протокола для передачи данных между различными компонентами интернет-служб.

Серверное программное обеспечение, выполняющее обработку запросов протокола HTTP, называют **веб-серверами**, обычно оно прослушивает порт TCP 80. Теоретически HTTP может работать поверх протокола UDP (также, как и новая версия — HTTP/3), но такие случаи крайне редки.

* Сообщение HTTP — это так называемый «простой текст», то есть обычный текст без специального форматирования.
* Запросы HTTP по умолчанию отправляются на порт 80.

## HTTPS

Основная проблема HTTP в том, что этот протокол небезопасен. Данные передаются как простой текст, поэтому, если вы используете этот протокол в открытой беспроводной сети, то кто-нибудь может подсмотреть ваши данные или даже изменить их.  
По этой причине большинство современных веб-сайтов используют протокол HTTPS — безопасную версию HTTP. Главное различие между этими двумя протоколами заключается в шифровании соединения клиента и сервера и в использовании другого порта (443 вместо 80).

**HyperText Transfer Protocol Secure** (защищённый протокол передачи гипертекста), HTTPS = HTTP + шифрование. Хотя для HTTPS нужно больше вычислительных ресурсов (по сравнению с HTTP), этот протокол препятствует доступу к конфиденциальной информации и осложняет попытки взлома.

* Сообщения HTTPS зашифрованы.
* На шифрование нужно время и дополнительные вычислительные мощности, поэтому HTTPS обычно работает медленнее HTTP.
* По умолчанию запросы HTTPS отправляются на порт 443.

## URL, URN, URI

Запросы по протоколу HTTP обычно отправляются для получения текста, документов, изображений и видео. Цель запроса называют **ресурсом**.

**URL - Universal Resource Locator** (унифицированный указатель ресурсов) — показывает, где именно на стороне сервера располагается ресурс.

**URN Uniform Resource Name** - это способ определения ресурса в рамках определенного пространства имён.

**URI - Uniform Resource Identifier** — это абсолютный путь к объекту, с которым вы хотите взаимодействовать. В самом простом случае это адрес веб-страницы, которую вы хотите посетить. Это абстракция, которая описывает, что и где находится в Интернете. Считается, что URI = URL + URN.

В большинстве случаев в повседневном использовании мы рассматриваем URI как URL.

Структура URL:  
<https://example.com:80/service/rest/v1?sort=name&dir=none>

`https://` - protocol (протокол) — определяет правила для доступа к ресурсу.  
`example.com` - host (узел) — адрес сервера.  
`80` - port (порт) — целевое приложение «слушает» этот порт и обрабатывает приходящие запросы.  
`service/rest/v1` - path (путь) — путь к ресурсу.  
`sort=name&dir=none` - parameters (параметры) — параметры для настройки запроса (ответы сервера меняются в зависимости от параметров).

## Методы HTTP

Методы HTTP:

* **GET** — прочитать данные на сервере.
* **POST** — создать что-нибудь на стороне сервера. Например, создание новой учётной записи пользователя.
* **PUT** — обновить некий ресурс.
* **DELETE** — удалить что-нибудь.
* **PATCH** — частичное обновление; например, изменение только имени пользователя или пароля.
* **HEAD** — аналогично GET, но в ответе возвращается только заголовок без тела сообщения (то есть только некоторые метаданные).
* **OPTIONS** — узнать, какие возможности (методы) поддерживаются сервером. Примечание: некоторые серверы могут поддерживать только GET или только POST.
* **CONNECT** — установить соединение.
* **TRACE** — проверить, в рабочем ли состоянии цель.

**CRUD**:  
CREATE-READ-UPDATE-DELETE (создать-прочитать-обновить-удалить).  
POST-GET-PUT-DELETE

`curl -v -X GET https://example.org` - отправить запрос: метод GET, расширенный вывод

## Запрос и ответ HTTP

HTTP — это простой текст. Но этот текст имеет специальную структуру:

* **Первая (начальная) строка** запроса содержит метод HTTP, запрашиваемый путь и версию протокола. Первая строка ответа содержит поддерживаемую версию протокола и код состояния ответа.
* **Заголовки**. Содержат служебную информацию
* **Тело**. Данные передаваемые в запросе или получаемые в ответе.

### Коды состояния HTTP

Код HTTP — это номер из трёх цифр, описывающий реакцию сервера на запрос клиента. Самые часто используемые коды следующие:

* 200 OK (хорошо). Всё хорошо, вот содержимое запрашиваемой страницы.
* 201 Created (Создано). Некий объект был успешно создан, например новая учётная запись пользователя.
* 301 Moved Permanently (перемещено навсегда). Ресурс с этим URI навсегда перемещён на новый адрес, указанный в заголовке ответа сервера.
* 302 Moved Temporarily (перемещено временно). Аналогично предыдущему, но перемещение временное. Часто ответы с кодом 301 и 302 означают одно и то же, это зависит от настроек веб-сервера (или веб-приложения), поэтому суть кодов 301 и 302 — «вот новый адрес, перейдите туда».
* 304 Not Modified (не изменялось). Если в запросе клиента использовался заголовок "If-Modified-Since" и ресурс не был изменён, то нет необходимости получать его снова.
* 400 Bad Request (недопустимый запрос). Что-то не так с вашим запросом.
* 401 Unauthorized (недостаточно прав). Для доступа к ресурсу с этим URI нужно пройти авторизацию. В таком ответе сервера содержится форма авторизации, для указания вашего имени пользователя и пароля.
* 403 Forbidden (запрещено).В доступе отказано. Отправляется, например, когда предоставленное имя пользователя и (или) пароль некорректны.
* 404 Not found (не найдено). Ресурс с этим URI не существует (или сервер хочет, чтобы вы так думали).
* 418 I’m a teapot (Я — чайник). Код из первоапрельской шутки. Нет необходимости в обработке этого кода.
* 500 Internal Server Error (внутренняя ошибка сервера). Что-то не так с сервером.
* 502 Bad Gateway (недопустимый шлюз). Сервер попытался передать ваш запрос другому серверу, но потерпел неудачу.
* 503 Service Unavailable (служба недоступна). Фактически то же самое, что и 500.
* 504 Gateway Timeout (истекло время ожидания шлюза). То же, что и 502, но в случае с ошибкой, связанной со временем ожидания.

### Заголовки HTTP

Заголовки — это пары ключ-значение.  
Например: `HOST: localhost:8000`  
Где HOST - это ключ (название заголовка), а localhost:8000 - значение (значение заголовка).

Заголовки можно рассматривать как метаинформацию, содержащую дополнительные указания серверу или клиенту и меняющие их действия.

Существуют так называемые основные или стандартные заголовки. Предполагается, что такие заголовки должен поддерживать любой сервер.

Примеры часто используемых заголовков на стороне клиента:

* Host (узел) нужен в большинстве случаев. Указывает серверу на веб-сайт, к которому вы хотите получить доступ.
* User-Agent (программный агент пользователя) позволяет веб-серверу определить версию вашего браузера (или версию, которую вы хотите выдать за используемую вами).
* If-Modified-Since (если-изменено-после). Показывает содержимое, только если оно было изменено с момента последней временной метки, содержащейся в этом заголовке.
* С помощью заголовка Content-Language (язык содержимого) можно указать язык содержимого, которое вы хотите получить (но нет никакой гарантии, что сервер поддерживает этот язык).

### Тело запроса и ответа HTTP

Запросы и ответы могут содержать полезные данные, помещаемые в тело сообщения.  
Тело запроса может содержать данные новой учётной записи пользователя.  
Тело ответа может содержать исходный код веб-страницы или просто сведения о только что созданной учётной записи.

Тело запросов и ответов может содержать различные типы данных (типы media, согласно стандарту): аудио, изображение, текст и т. д.  
При отправке запросов PUT или POST этот тип указывается, к примеру, в заголовке  Content-type:  
`Content-Type: text/html; charset=utf-8`

## Архитектурный стиль REST

**REST** (REpresentational State Transfer - передача самоописываемого состояния)— это стиль архитектуры программного обеспечения, определяющий набор правил, ограничений, рекомендаций для разработки веб-приложений (в основном веб-служб и API), которые при соблюдении всего этого можно назвать RESTful. В основе REST лежит HTTP: он определяет способы, с помощью которых клиент создаёт ресурсы на стороне сервера и получает доступ к ним. Тестировщики, которые в рамках своей деятельности используют веб-службы, соответствующие требованиям RESTful, могут ожидать, что запрос HTTP GET используется для чтения данных, HTTP POST — для создания новых ресурсов (например, записей баз данных), HTTP PUT — для обновления существующих ресурсов, а HTTP DELETE — для их удаления.

С точки зрения инженера по тестированию архитектурный стиль REST определяет следующее:

* Должны быть сервер и клиент(ы). В большинстве случаев обе стороны ничего не знают о деталях реализации друг друга. Важен только набор правил, служащих для создания ресурсов на сервере и доступа к ним.
* Стиль REST основан на протоколе HTTP, поэтому тестирование веб-служб, отвечающих требованиям RESTful, следует проводить с помощью отправки запросов HTTP и проверки ответов HTTP.

## API

**API** (Application Programming Interface - программный интерфейс приложения) - это набор правил взаимодействия с конкретным приложением, с помощью которых с ним могут «общаться» другие приложения.

Существуют различные API:

* Для работы с аппаратным обеспечением, например, API для жёсткого диска.
* Для работы с операционной системой (доступ к файловой системе, доступ к интерфейсу пользователя).
* Для объектно-ориентированного программирования (Java API, Android API).
* Веб-ориентированные (API, использующие SOAP, REST, GraphQL)  
и т.д.

Виды веб-ориентированных API:

* API, использующие протокол **SOAP** (Simple Object Access Protocol — простой протокол доступа к объектам). Были популярны в начале 2000-х и могут всё ещё встречаться в старых приложениях.
* В наши дни наиболее популярны API с поддержкой архитектурного стиля **REST** (RESTful).
* **GraphQL** (QL означает Query Language, язык запросов) — это своего рода SQL для API, служащий для реализации запросов к данным в программном интерфейсе приложения. В его основе лежит идея снижения нагрузки на сеть благодаря ограничению объёмов данных в ответе (например, вместо полной информации пользователей, можно возвращать только имена). Некоторые рассматривают GraphQL как подход следующего поколения и современную замену REST.

### Документация для API

Чтобы соблюдать правила, вы должны их знать, поэтому для программных интерфейсов API предусмотрена документация. Существуют различные типы документации, которые можно разделить на две большие группы: *классическая документация* (Пример веб-страницы со статическими таблицами и текстами(opens in a new tab)) и *динамическая* (в большинстве случаев формируемая «на лету»). Главный недостаток классической документации в том, что её сведения могут быть устаревшими. С другой стороны, она понятна и легко читается. Существует значительное количество инструментов и спецификаций для создания динамической документации, например, Swagger, OpenAPI.

### Инструменты для тестирования

#### cURL

`-X / --request` — указывает применяемый метод HTTP.  
`-d / --data` — задаёт содержимое тела запроса.  
`-H` — определяет заголовки запроса.  
`-u` — позволяет передать имя пользователя и пароль, если серверу требуется проверка подлинности.  
`-k` — предписывает программе cURL игнорировать проблемы, связанные с сертификатом безопасности (применение этой опции небезопасно!).  
`-v` — переключение в режим подробного вывода (чтобы получить больше сведений).  

`curl -X 'GET'   'https://catfact.ninja/fact'   -H 'accept: application/json' -k`

```shell
curl -X 'POST' \
  'https://petstore.swagger.io/v2/pet' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "name": "Petty",
  "status": "available"
}'
```

`curl -X 'GET' 'https://petstore.swagger.io/v2/pet/9223372016900014653' -H 'accept: application/json'`

`curl -X 'DELETE' 'https://petstore.swagger.io/v2/pet/9223372016900014653' -H 'accept: application/json' -H 'api_key: special_key'`

#### Swagger

Страница на платформе Swagger представляет собой следующее:

* Документация с текущей актуальной информацией об API (описывает вызовы API и данные, которые могут быть отправлены и получены).
* Инструмент для выполнения запросов API.

#### Подключаемые модули веб-браузеров

* Boomerang (Chrome)
* RESTED (Firefox)

#### Postman

### Тестирование REST API

1. Поддерживает ли тестируемый программный интерфейс API все методы HTTP?
2. Варианты ответов: похожие ответы могут быть получены при различных запросах (например, сведения о пользователе, полученные по идентификатору, имени и фамилии, номеру паспорта и номеру страхового договора).
3. Структура запросов и ответов: какая структура корректная, какая некорректная, какие запросы и ответы вообще возможны.
4. Коды ответов: какие коды, приходящие в ответах, может получать клиент.
5. Обязательные и необязательные параметры URL-адреса и поля тела запроса (перечень конкретных параметров и полей). И что должно прийти в ответ на запрос без обязательных данных.
6. Какие поддерживаются типы данных: символьные строки, числа, даты (значения дата-время обычно не являются источником проблем).
7. Пределы и ограничения: например, ограничение по длине имени пользователя в 121 знак. Что, если в теле запроса будет имя из 122 знаков?
